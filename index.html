<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Photoshop Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-bg: #2d2d2d;
            --panel-bg: #3d3d3d;
            --toolbar-bg: #252525;
            --active-color: #0078d7;
        }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--dark-bg);
            color: white;
            height: 100vh;
            display: grid;
            grid-template-columns: 50px auto 200px;
            grid-template-rows: 40px auto 150px;
            overflow: hidden;
        }
        /* [Previous CSS styles remain the same...] */
        .font-selector {
            padding: 5px;
            border-radius: 3px;
            background: #4d4d4d;
            color: white;
            border: 1px solid #666;
        }
        .effect-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .effect-buttons button {
            padding: 5px 8px;
            background: #555;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains the same...] -->

    <!-- Updated Tool Options -->
    <div class="tool-options" id="tool-options">
        <!-- Dynamic options will appear here -->
    </div>

    <script>
        // [Previous initialization code...]

        // Enhanced Tool Functionality
        document.querySelectorAll('.tool-panel button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelector('.tool-panel button.active').classList.remove('active');
                this.classList.add('active');
                state.activeTool = this.id.replace('-tool', '');
                updateToolOptions();
            });
        });

        function updateToolOptions() {
            const optionsBar = document.getElementById('tool-options');
            optionsBar.innerHTML = '';

            switch(state.activeTool) {
                case 'text':
                    optionsBar.innerHTML = `
                        <select class="font-selector" id="font-family">
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                        </select>
                        <input type="number" id="font-size" value="24" min="8" max="120">
                        <input type="color" id="text-color" value="#000000">
                        <button onclick="addTextToCanvas()">Add Text</button>
                    `;
                    break;
                
                case 'brush':
                    optionsBar.innerHTML = `
                        Brush Size: <input type="range" id="brush-size" min="1" max="50" value="5">
                        Color: <input type="color" id="brush-color" value="#000000">
                        Opacity: <input type="range" id="brush-opacity" min="1" max="100" value="100">
                    `;
                    break;
                
                case 'filter':
                    optionsBar.innerHTML = `
                        <div class="effect-buttons">
                            <button onclick="applyFilter('grayscale')">Grayscale</button>
                            <button onclick="applyFilter('sepia')">Sepia</button>
                            <button onclick="applyFilter('invert')">Invert</button>
                            <button onclick="applyFilter('blur')">Blur</button>
                            <button onclick="applyFilter('brightness')">Brightness</button>
                            <button onclick="applyFilter('contrast')">Contrast</button>
                        </div>
                    `;
                    break;
            }
        }

        // Enhanced Text Functionality
        function addTextToCanvas() {
            const fontFamily = document.getElementById('font-family').value;
            const fontSize = parseInt(document.getElementById('font-size').value);
            const textColor = document.getElementById('text-color').value;

            const text = new fabric.Textbox('Edit me', {
                left: 100,
                top: 100,
                fontFamily: fontFamily,
                fontSize: fontSize,
                fill: textColor,
                width: 200,
                selectable: true
            });
            canvas.add(text);
            saveState();
            updateLayersPanel();
        }

        // Advanced Filter Effects
        function applyFilter(type) {
            const activeObject = canvas.getActiveObject();
            if (!activeObject || !activeObject.filters) return;

            switch(type) {
                case 'grayscale':
                    activeObject.filters.push(new fabric.Image.filters.Grayscale());
                    break;
                case 'sepia':
                    activeObject.filters.push(new fabric.Image.filters.Sepia());
                    break;
                case 'invert':
                    activeObject.filters.push(new fabric.Image.filters.Invert());
                    break;
                case 'blur':
                    activeObject.filters.push(new fabric.Image.filters.Blur({ blur: 0.2 }));
                    break;
                case 'brightness':
                    activeObject.filters.push(new fabric.Image.filters.Brightness({ brightness: 0.1 }));
                    break;
                case 'contrast':
                    activeObject.filters.push(new fabric.Image.filters.Contrast({ contrast: 0.1 }));
                    break;
            }

            activeObject.applyFilters();
            canvas.renderAll();
            saveState();
        }

        // Brush Drawing Functionality
        let isDrawing = false;
        canvas.on('mouse:down', function(o) {
            if (state.activeTool === 'brush') {
                isDrawing = true;
                const pointer = canvas.getPointer(o.e);
                const brushSize = parseInt(document.getElementById('brush-size').value);
                const brushColor = document.getElementById('brush-color').value;
                
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.width = brushSize;
                canvas.freeDrawingBrush.color = brushColor;
                canvas.isDrawingMode = true;
            }
        });

        canvas.on('mouse:up', function() {
            if (state.activeTool === 'brush') {
                isDrawing = false;
                canvas.isDrawingMode = false;
                saveState();
                updateLayersPanel();
            }
        });

        // [Rest of the previous JavaScript code...]
    </script>
</body>
</html>
